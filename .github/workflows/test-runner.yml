name: Test Self-hosted Runner

on:
  workflow_dispatch:

jobs:
  run-on-test-03:
    runs-on: [self-hosted, test-03]
    defaults:
      run:
        working-directory: /home/ckb/scz
    steps:
      - name: Fund addresses
        run: |
          pkill fnn || true
          rm -rf fiber-stability-test-nodes
          git clone https://github.com/sunchengzhu/fiber-stability-test-nodes.git
          cd fiber-stability-test-nodes
          /opt/gradle/gradle-8.5/bin/gradle wrapper
          ./gradlew run
      - name: Prepare
        run: |
          cd fiber-stability-test-nodes/remote
          bash 1_prepare.sh
      - name: Run
        run: |
          sudo systemctl start fnn.service
          sleep 30
          sudo journalctl -u fnn.service --since "1 minutes ago"

  run-on-test-04:
    runs-on: [self-hosted, test-04]
    defaults:
      run:
        working-directory: /home/ckb/scz
    steps:
      - name: Clone fiber-stability-test-nodes
        run: |
          pkill fnn || true
          rm -rf fiber-stability-test-nodes
          git clone https://github.com/sunchengzhu/fiber-stability-test-nodes.git
      - name: Prepare
        run: |
          cd fiber-stability-test-nodes/remote
          bash 1_prepare.sh
      - name: Run
        run: |
          sudo systemctl start fnn.service
          sleep 10
          sudo journalctl -u fnn.service --since "1 minutes ago"

  run-on-test-05:
    runs-on: [self-hosted, test-05]
    defaults:
      run:
        working-directory: /home/ckb/scz
    steps:
      - name: Clone fiber-stability-test-nodes
        run: |
          pkill fnn || true
          rm -rf fiber-stability-test-nodes
          git clone https://github.com/sunchengzhu/fiber-stability-test-nodes.git
      - name: Prepare
        run: |
          cd fiber-stability-test-nodes/remote
          bash 1_prepare.sh
      - name: Run
        run: |
          sudo systemctl start fnn.service
          sleep 10
          sudo journalctl -u fnn.service --since "1 minutes ago"

  connect-peer-test-03:
    runs-on: [self-hosted, test-03]
    defaults:
      run:
        working-directory: /home/ckb/scz/fiber-stability-test-nodes/remote
    needs: [run-on-test-03, run-on-test-04, run-on-test-05]
    steps:
      - name: Connect Peer
        run: bash 3_connect_peer.sh

  connect-peer-test-04:
    runs-on: [self-hosted, test-04]
    defaults:
      run:
        working-directory: /home/ckb/scz/fiber-stability-test-nodes/remote
    needs: [run-on-test-03, run-on-test-04, run-on-test-05]
    steps:
      - name: Connect Peer
        run: bash 3_connect_peer.sh

  connect-peer-test-05:
    runs-on: [self-hosted, test-05]
    defaults:
      run:
        working-directory: /home/ckb/scz/fiber-stability-test-nodes/remote
    needs: [run-on-test-03, run-on-test-04, run-on-test-05]
    steps:
      - name: Connect Peer
        run: bash 3_connect_peer.sh

  open-channel-test-03:
    runs-on: [self-hosted, test-03]
    defaults:
      run:
        working-directory: /home/ckb/scz/fiber-stability-test-nodes/remote
    needs: [connect-peer-test-03, connect-peer-test-04, connect-peer-test-05]
    steps:
      - name: Open channel
        run: |
          bash 4_open_channel.sh
          bash count_channels.sh

  open-channel-test-04:
    runs-on: [self-hosted, test-04]
    defaults:
      run:
        working-directory: /home/ckb/scz/fiber-stability-test-nodes/remote
    needs: [connect-peer-test-03, connect-peer-test-04, connect-peer-test-05]
    steps:
      - name: Open channel
        run: |
          bash 4_open_channel.sh
          bash count_channels.sh

  open-channel-test-05:
    runs-on: [self-hosted, test-05]
    defaults:
      run:
        working-directory: /home/ckb/scz/fiber-stability-test-nodes/remote
    needs: [connect-peer-test-03, connect-peer-test-04, connect-peer-test-05]
    steps:
      - name: Open channel
        run: |
          bash 4_open_channel.sh
          bash count_channels.sh
